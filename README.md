# XLORM - Lightweight Database ORM Framework for Go Language

[中文版](README_ZH.md "Visit Chinese Version")

[English](README.md "Access English Version")

## Introduction

XLORM is a high-performance, easy-to-use lightweight ORM framework designed specifically for Go language, supporting MySQL databases. It provides comprehensive CRUD operations, transaction management, batch processing, query builders, cache support, and built-in logging and performance monitoring modules, helping developers quickly build robust database applications.

**XLORM is generated by Windsurf AI command generation and code-reviewed by DeepSeek R1 for performance optimization suggestions.**

## Key Features

- **Complete CRUD Support**: Simplify data operations, supporting struct and map data types
- **Transaction Management**: Provide atomic operations and nested transaction support
- **Batch Operation Optimization**: Efficiently handle large-scale data insertion/updates
- **Query Builder**: Chain calls generate safe SQL, preventing injection
- **Cache Support**: Built-in sharded lock cache, improving high-frequency query performance
- **Logging and Monitoring**: Asynchronous log recording, slow query alerts, connection pool statistics
- **Connection Pool Management**: Support connection health checks, timeout control, connection reuse

### 1. High-Performance Design
- Asynchronous performance metrics collection
- Connection pool management
- Batch operation optimization
- Caching mechanism (struct field caching, placeholder caching)

### 2. Flexible Database Operations
- Support for various database operations (CRUD)
- Transaction processing
- Dynamic query building
- Field mapping and conversion

### 3. Logging System
- Structured log recording
- Log rotation
- Configurable log levels
- Asynchronous log processing

### 4. Security
- SQL injection protection
- Field escaping
- Secure parameter binding
- Connection timeout control

### 5. Debugging Support
- Detailed debug mode
- Performance metrics tracking
- Slow query monitoring
- Detailed system runtime status reporting

### 6. Dynamic Configuration
- Runtime configuration modification
- Hot update of connection pool parameters
- Flexible log level adjustment

## Performance Comparison with GORM/XORM

### 1. GORM
#### Advantages
- Rich features, supporting model associations, hooks, migrations, etc.
- Active community, comprehensive documentation, rich plugin ecosystem

#### Disadvantages
- Heavy use of reflection, relatively lower performance, especially in complex queries or high-frequency operations
- Weak logging and metrics capabilities, requires external libraries (e.g., Prometheus)

### 2. XORM
#### Advantages
- Better performance than GORM, supports read/write separation and cache optimization
- More flexible condition builder

#### Disadvantages
- Less optimized async processing and batch operations compared to XLORM
- Logging and monitoring features require manual integration

### 3. XLORM
#### Performance Highlights
- **Batch Operations**: Reduce network round trips and lock contention through transaction batch commits
- **Cache Design**: Sharded LRU cache improves high-frequency query efficiency
- **Object Pooling**: Reduces GC pressure, suitable for high concurrency scenarios

#### Applicable Scenarios
- High-performance batch writes (e.g., log ingestion, data synchronization)
- Projects with high requirements for custom logging and monitoring

### Summary

| Dimension   | GORM                | XORM                | XLORM               |
|-------------|---------------------|---------------------|---------------------|
| Features    | Rich (associations) | Medium (R/W split)  | Basic (CRUD/batch)  |
| Performance | Low                 | Medium              | High (batch/cache)  |
| Security    | Medium              | Medium              | High (injection protection) |
| Usability   | High (docs)         | Medium              | High (docs)         |
| Use Cases   | Complex logic       | General OLTP        | High-frequency batch writes |

### Recommendations
- Choose **GORM** if you need advanced features (associations, migrations)
- Choose **XORM** for balanced performance and features
- Choose **XLORM** for ultimate performance in simple scenarios (e.g., data synchronization)

#### Benchmark reports, module descriptions, and other details can be found in the md directory.

## Installation

```bash
go get github.com/go-sql-driver/mysql
go get github.com/jiankeluoluo/xlorm
```

## Quick Start

### 1. Database Connection

```go
import "your_project/db"

// Configure database connection
config := &db.Config{
    DBName:            "master",               // Database alias for distinguishing different database instances
    Driver:            "MySQL",                 // Database driver type, currently only supports "MySQL"
    Host:              "localhost",             // Database server address, supports IP or domain
    Port:              3306,                    // Database server port, MySQL default is 3306
    Username:          "your_username",         // Database login username
    Password:          "your_password",         // Database login password
    Database:          "your_database",         // Specific database name to connect
    Charset:           "utf8mb4",               // Database character set, recommended utf8mb4 for full Unicode support
    TablePrefix:       "tb_",                   // Table name prefix for multi-project or module shared database
    LogDir:            "./logs",                // Log file storage directory, supports relative and absolute paths
    LogLevel:          "debug",                 // Log level, optional debug/info/warn/error, recommended debug during development
    LogBufferSize:     5000,                   // Log buffer size, default 5000
    LogRotationEnabled: true,                   // Enable log rotation
    LogRotationMaxAge:  30,                     // Log retention for 30 days

    // Connection lifecycle configuration
    ConnMaxLifetime:   30 * time.Minute,        // Maximum connection lifetime, recreate if exceeded
    ConnMaxIdleTime:   10 * time.Minute,        // Maximum idle connection retention time

    // Timeout configuration
    ConnTimeout:       5 * time.Second,         // Database connection establishment timeout
    ReadTimeout:       3 * time.Second,         // Data read timeout
    WriteTimeout:      3 * time.Second,         // Data write timeout
    SlowQueryTime:     200 * time.Millisecond,  // Slow query threshold, queries exceeding this time will be logged

    // Connection pool configuration
    PoolStatsInterval: 1 * time.Minute,         // Connection pool statistics collection interval
    MaxOpenConns:      100,                     // Maximum open connections, controlling maximum database concurrent connections
    MaxIdleConns:      20,                      // Maximum idle connections, reducing frequent connection creation and destruction

    // Debugging and monitoring
    EnablePoolStats:   true,                    // Whether to enable performance metric collection
    Debug:             true,                    // Whether to enable debug mode, will output more detailed logs
}

// Create database connection
xdb, err := db.New(config)
if err != nil {
    log.Fatal(err)
}
defer xdb.Close()
```

## Configuration Options Explained

XLORM provides rich and flexible configuration options, each carefully designed to meet different scenario requirements.

### Database Connection Configuration

| Configuration | Type | Default | Description | Recommended Setting |
|--------------|------|---------|-------------|---------------------|
| `DBName` | `string` | `""` | Database alias for distinguishing different database instances | Recommend setting a meaningful name |
| `Driver` | `string` | `"MySQL"` | Database driver type | Currently only supports MySQL |
| `Host` | `string` | `"localhost"` | Database server address | Use actual server address in production |
| `Port` | `int` | `3306` | Database server port | MySQL default is 3306 |
| `Username` | `string` | `""` | Database login username | Use user with minimal privileges |
| `Password` | `string` | `""` | Database login password | Recommend using environment variables |
| `Database` | `string` | `""` | Specific database name to connect | Required |

### Connection Pool Configuration

| Configuration | Type | Default | Description | Performance Suggestions |
|--------------|------|---------|-------------|-------------------------|
| `MaxOpenConns` | `int` | `100` | Maximum open connections | Adjust based on business concurrency, avoid overload |
| `MaxIdleConns` | `int` | `20` | Maximum idle connections | Balance memory usage and connection reuse |
| `ConnMaxLifetime` | `time.Duration` | `30 * time.Minute` | Maximum connection lifetime | Prevent long connection resource leaks |
| `ConnMaxIdleTime` | `time.Duration` | `10 * time.Minute` | Maximum idle connection retention time | Control connection recycling frequency |

### Timeout and Security Configuration

| Configuration | Type | Default | Description | Security Recommendations |
|--------------|------|---------|-------------|--------------------------|
| `ConnTimeout` | `time.Duration` | `5 * time.Second` | Connection establishment timeout | Adjust based on network conditions |
| `ReadTimeout` | `time.Duration` | `3 * time.Second` | Data read timeout | Avoid long-time blocking |
| `WriteTimeout` | `time.Duration` | `3 * time.Second` | Data write timeout | Prevent write operations from hanging |
| `SlowQueryTime` | `time.Duration` | `200 * time.Millisecond` | Slow query threshold | Set reasonably to detect performance issues |

## Asynchronous Performance Metrics

```go
// Asynchronous performance metrics to reduce impact on main business
asyncMetrics := xdb.AsyncMetrics()

// Get the number of dropped metrics (if metrics channel is full)
droppedMetricsCount := asyncMetrics.GetDroppedMetricsCount()
```

### Connection Pool Metrics

```go
// Get connection pool statistics
stats := xdb.GetPoolStats()

// Print connection pool information
fmt.Printf("Connection Pool Status:\n")
fmt.Printf("Maximum Connections: %d\n", stats.MaxOpenConnections)
fmt.Printf("Current Open Connections: %d\n", stats.OpenConnections)
fmt.Printf("Connections In Use: %d\n", stats.InUse)
fmt.Printf("Idle Connections: %d\n", stats.Idle)
fmt.Printf("Wait Count: %d\n", stats.WaitCount)
fmt.Printf("Total Wait Duration: %v\n", stats.WaitDuration)
fmt.Printf("Connections Closed Due to Max Idle Time: %d\n", stats.MaxIdleClosed)
fmt.Printf("Connections Closed Due to Max Lifetime: %d\n", stats.MaxLifetimeClosed)
```

## Security Recommendations

### Configuration Security
- Avoid hardcoding sensitive information
- Use environment variables to manage database credentials
- Limit connection pool size to prevent resource exhaustion

### Data Masking
- Automatically mask sensitive information in logs
- Support custom masking rules

## Contributing

We welcome contributions! Here are some ways you can contribute to XLORM:

### Reporting Issues
- If you find a bug or have a feature request, please open an issue on our GitHub repository.
- Provide a clear and detailed description of the problem or suggestion.
- Include steps to reproduce the issue, if applicable.

### Pull Requests
- Fork the repository and create your branch from `main`.
- Ensure your code follows the project's coding standards.
- Write clear, concise commit messages.
- Include tests for new features or bug fixes.
- Update documentation if necessary.

### Code of Conduct
- Be respectful and inclusive.
- Provide constructive feedback.
- Collaborate and help each other grow.

### Development Setup
1. Clone the repository
2. Install dependencies
3. Run tests
4. Make your changes
5. Submit a pull request

## Contact

For questions, support, or collaboration, please contact:
- Email: [your email]
- GitHub: [project repository]
- Website: [project website]

## Acknowledgments
- Thanks to all contributors who help improve XLORM
- Inspired by existing ORM frameworks
- Powered by Windsurf AI and DeepSeek R1

## License

MIT License
